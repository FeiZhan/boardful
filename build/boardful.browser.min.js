/*! boardful browser 2015-01-20 */
var BOARDFUL=BOARDFUL||new Object;BOARDFUL.init=function(){BOARDFUL.ENGINE.checkEnvi(),BOARDFUL.Logger=new BOARDFUL.ENGINE.Logger,BOARDFUL.Logger.add(winston.transports.File,{filename:"logs/boardful.log"}).remove(winston.transports.Console),BOARDFUL.Debugger=new BOARDFUL.ENGINE.Logger,BOARDFUL.Debugger.add(winston.transports.File,{filename:"logs/debug.log"}).remove(winston.transports.Console),BOARDFUL.Logger.log("info","environment",BOARDFUL.ENGINE.Envi),BOARDFUL.Debugger.log("info","start"),BOARDFUL.ENGINE.initFileMngr(),"browser"==BOARDFUL.ENGINE.Envi.type&&(BOARDFUL.urlparam=BOARDFUL.ENGINE.parseUrl(),BOARDFUL.Logger.log("info","url param",BOARDFUL.urlparam),BOARDFUL.ENGINE.getFilesInHtml())},BOARDFUL.run=function(a){switch(BOARDFUL.Logger.log("info","start type",a),a){case"server":BOARDFUL.SERVER.port=process.argv[3]||8080,BOARDFUL.SERVER.createServer();break;case"browser":BOARDFUL.MENUS.run();break;case"desktop":default:global.jquery=require("jquery"),global.$=jquery.create(),BOARDFUL.DESKTOP.menuRun()}};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.ENGINE=BOARDFUL.ENGINE||new Object,BOARDFUL.ENGINE.Card=function(a){this.id=BOARDFUL.ENGINE.Card.next_id,BOARDFUL.ENGINE.CardList[this.id]=this,++BOARDFUL.ENGINE.Card.next_id,this.value=a.value,this.suit=a.suit,this.color=a.color},BOARDFUL.ENGINE.Card.next_id=0,BOARDFUL.ENGINE.CardList=new Object,BOARDFUL.ENGINE.loadCards=function(a){var b=new Array;switch(a){case"poker":b=BOARDFUL.ENGINE.loadPoker()}return b},BOARDFUL.ENGINE.loadPoker=function(a){a=a||1;for(var b,c=new Array,d=0;a>d;++d)for(var e=1;13>=e;++e){var f=e;switch(e){case 11:f="Jack";break;case 12:f="Queen";break;case 13:f="King";break;default:f=e}for(var g in["spade","heart","diamond","club"])b=new BOARDFUL.ENGINE.Card({value:f,suit:g,color:g%2?"red":"black"}),c.push(b.id)}return c};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.ENGINE=BOARDFUL.ENGINE||new Object,BOARDFUL.ENGINE.Deck=function(){this.id=BOARDFUL.ENGINE.Deck.next_id,BOARDFUL.ENGINE.DeckList[this.id]=this,++BOARDFUL.ENGINE.Deck.next_id,this.card_list=new Array},BOARDFUL.ENGINE.Deck.next_id=0,BOARDFUL.ENGINE.DeckList=new Object,BOARDFUL.ENGINE.Deck.prototype.getCards=function(a){this.card_list=this.card_list.concat(a)},BOARDFUL.ENGINE.Deck.prototype.shuffle=function(){this.card_list=BOARDFUL.ENGINE.shuffle(this.card_list)},BOARDFUL.ENGINE.Deck.prototype.dealCards=function(a){for(var b=new Array,c=0;a>c;++c)b.push(this.card_list[0]),this.card_list.shift();return b};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.ENGINE=BOARDFUL.ENGINE||new Object,BOARDFUL.ENGINE.Event=function(a){this.id=BOARDFUL.ENGINE.Event.next_id,BOARDFUL.ENGINE.EventList[this.id]=this,++BOARDFUL.ENGINE.Event.next_id,this.name=a.name,this.arg=a,this.arg.creation_time=new Date},BOARDFUL.ENGINE.Event.next_id=0,BOARDFUL.ENGINE.EventList=new Object,BOARDFUL.ENGINE.EventLevels=["top","system","server","board","room","game","extension","player","card","rear"],BOARDFUL.ENGINE.EventMngr=function(){this.list=new Array,this.listenerList=new Object,this.timeout=300,this.logger=new BOARDFUL.ENGINE.Logger,this.logger.add(winston.transports.File,{filename:"logs/event.log"}).remove(winston.transports.Console)},BOARDFUL.ENGINE.EventMngr.prototype.front=function(a){if(void 0===a){if(0==this.list.length)return void 0}else"array"==typeof a||"object"==typeof a?(this.list=a.concat(this.list),this.logger.log("info","prepend events",a,this.list)):(this.list.unshift(a),this.logger.log("info","prepend event",a,this.list));return BOARDFUL.ENGINE.EventList[this.list[0]]},BOARDFUL.ENGINE.EventMngr.prototype.add=function(a){"array"==typeof a||"object"==typeof a?(this.list=this.list.concat(a),this.logger.log("info","append events",a,this.list)):(this.list.push(a),this.logger.log("info","append event",a,this.list))},BOARDFUL.ENGINE.EventMngr.prototype.on=function(a,b){a in this.listenerList||(this.listenerList[a]=new Object),b.level=b.level||"rear",b.level in this.listenerList[a]||(this.listenerList[a][b.level]=new Array),this.listenerList[a][b.level].push(b),this.logger.log("info","add listener",a,b)},BOARDFUL.ENGINE.EventMngr.prototype.off=function(a,b){if(a in this.listenerList&&(b.level=b.level||"extension",b.level in this.listenerList[a])){var c=this.listenerList[a][b.level].indexOf(b);c>=0&&this.listenerList[a][b.level].splice(c,1)}},BOARDFUL.ENGINE.EventMngr.prototype.run=function(){if(this.list.length>0){var a=this.front();if(this.logger.log("info","event",a,this.list),this.list.shift(),a&&a.name in this.listenerList)for(var b in BOARDFUL.ENGINE.EventLevels)if(BOARDFUL.ENGINE.EventLevels[b]in this.listenerList[a.name])for(var c in this.listenerList[a.name][BOARDFUL.ENGINE.EventLevels[b]]){var d=this.listenerList[a.name][BOARDFUL.ENGINE.EventLevels[b]][c];d.callback(a.arg),this.logger.log("info","trigger",d)}}var e=this;setTimeout(function(){e.run()},this.timeout)};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.ENGINE=BOARDFUL.ENGINE||new Object,BOARDFUL.ENGINE.initFileMngr=function(){BOARDFUL.ENGINE.FileLogger=new BOARDFUL.ENGINE.Logger,BOARDFUL.ENGINE.FileLogger.add(winston.transports.File,{filename:"logs/file.log"}).remove(winston.transports.Console)},BOARDFUL.ENGINE.FileList=new Object,BOARDFUL.ENGINE.FileNameList=new Object,BOARDFUL.ENGINE.NextFileId=0,BOARDFUL.ENGINE.addToFileList=function(a,b,c){a in BOARDFUL.ENGINE.FileNameList?BOARDFUL.ENGINE.FileList[BOARDFUL.ENGINE.FileNameList[a]]={name:a,content:b,status:c}:(BOARDFUL.ENGINE.FileList[BOARDFUL.ENGINE.NextFileId]={name:a,type:"",content:b,status:c},BOARDFUL.ENGINE.FileNameList[a]=BOARDFUL.ENGINE.NextFileId,++BOARDFUL.ENGINE.NextFileId)},BOARDFUL.ENGINE.getFilesInHtml=function(){$("script").each(function(){BOARDFUL.ENGINE.addToFileList($(this).attr("src"),$(this),"loaded")}),BOARDFUL.ENGINE.FileLogger.log("info","files in html",BOARDFUL.ENGINE.FileNameList)},BOARDFUL.ENGINE.loadFile=function(a){switch(BOARDFUL.ENGINE.Envi.type){case"browser":BOARDFUL.ENGINE.loadFileAjax(a);break;case"nodejs":try{var b=require("../"+a);BOARDFUL.ENGINE.addToFileList(a,b,"loaded"),BOARDFUL.ENGINE.FileLogger.log("info","file loaded",a)}catch(c){BOARDFUL.ENGINE.addToFileList(a,"","failed"),BOARDFUL.ENGINE.FileLogger.log("info","file failed",a,c)}}},BOARDFUL.ENGINE.loadFileAjax=function(a){".js"==a.substr(a.length-3)?$.getScript(a).done(function(b){BOARDFUL.ENGINE.addToFileList(a,b,"loaded"),BOARDFUL.ENGINE.FileLogger.log("info","js loaded",a)}).fail(function(){BOARDFUL.ENGINE.addToFileList(a,"","failed"),BOARDFUL.ENGINE.FileLogger.log("info","js failed",a)}):".css"==a.substr(a.length-4)?($("head").append($('<link rel="stylesheet" type="text/css" />').attr("href",a)),BOARDFUL.ENGINE.addToFileList(a,"","loaded"),BOARDFUL.ENGINE.FileLogger.log("info","css loaded"),BOARDFUL.ENGINE.FileLogger.log("info",a)):".json"==a.substr(a.length-5)?$.getJSON(a,function(b){BOARDFUL.ENGINE.addToFileList(a,b,"loaded"),BOARDFUL.ENGINE.FileLogger.log("info","json loaded",a)}).fail(function(){BOARDFUL.ENGINE.addToFileList(a,"","failed"),BOARDFUL.ENGINE.FileLogger.log("info","json failed",a)}).always(function(){}):(BOARDFUL.ENGINE.addToFileList(a,"","failed"),BOARDFUL.ENGINE.FileLogger.log("info","file unknown",a))},BOARDFUL.ENGINE.FileLoader=function(a,b){this.list=a,this.callback=b,this.done=!1,this.load()},BOARDFUL.ENGINE.FileLoader.prototype.load=function(){BOARDFUL.ENGINE.FileLogger.log("info","loading",this.list),this.done=!0;for(var a in this.list)this.list[a]in BOARDFUL.ENGINE.FileNameList&&"loaded"==BOARDFUL.ENGINE.FileList[BOARDFUL.ENGINE.FileNameList[this.list[a]]].status||(this.done=!1,BOARDFUL.ENGINE.loadFile(this.list[a]));var b=this;this.done?this.callback():setTimeout(function(){b.load()},500)};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.ENGINE=BOARDFUL.ENGINE||new Object,BOARDFUL.ENGINE.Game=function(a){if(this.id=BOARDFUL.ENGINE.Game.next_id,BOARDFUL.ENGINE.GameList[this.id]=this,++BOARDFUL.ENGINE.Game.next_id,this.event_mngr=new BOARDFUL.ENGINE.EventMngr,a instanceof BOARDFUL.ENGINE.Room){this.config=a.config,this.options=a.options,this.deck_list={draw:(new BOARDFUL.ENGINE.Deck).id,discard:(new BOARDFUL.ENGINE.Deck).id},this.player_list=new Array,this.current_player=-1;for(var b in a.player_list){var c=new BOARDFUL.ENGINE.Player(a.player_list[b],this.id);this.player_list.push(c.id)}}this.addListeners();var d=new BOARDFUL.ENGINE.Event({source_type:"game",source_id:this.id,name:"GameStart"});this.event_mngr.add(d.id)},BOARDFUL.ENGINE.Game.next_id=0,BOARDFUL.ENGINE.GameList=new Object,BOARDFUL.ENGINE.Game.prototype.addListeners=function(){var a=this;this.event_mngr.on("GameStart",{level:"game",callback:function(b){a.start(b)},instance:a}),this.event_mngr.on("RoundStart",{level:"game",callback:function(b){a.roundStart(b)},instance:a}),this.event_mngr.on("RoundEnd",{level:"game",callback:function(b){a.roundEnd(b)},instance:a}),this.event_mngr.on("PlayerStart",{level:"game",callback:function(b){a.playerStart(b)},instance:a}),this.event_mngr.on("DealCards",{level:"game",callback:function(b){a.dealCards(b)},instance:a})},BOARDFUL.ENGINE.Game.prototype.run=function(){this.event_mngr.run()},BOARDFUL.ENGINE.Game.prototype.start=function(){this.round=0,this.player_list=BOARDFUL.ENGINE.shuffle(this.player_list);var a=BOARDFUL.ENGINE.loadCards("poker");BOARDFUL.ENGINE.DeckList[this.deck_list.draw].getCards(a),BOARDFUL.ENGINE.DeckList[this.deck_list.draw].shuffle();var b=new Array;for(var c in this.player_list){var d=new BOARDFUL.ENGINE.Event({source_type:"game",source_id:this.id,name:"DealCards",deck:"draw",player:this.player_list[c],number:5});b.push(d.id)}var d=new BOARDFUL.ENGINE.Event({source_type:"game",source_id:this.id,name:"RoundStart"});b.push(d.id),this.event_mngr.front(b)},BOARDFUL.ENGINE.Game.prototype.roundStart=function(){++this.round;var a,b=new Array;for(var c in this.player_list)a=new BOARDFUL.ENGINE.Event({source_type:"game",source_id:this.id,name:"PlayerStart"}),b.push(a.id),a=new BOARDFUL.ENGINE.Event({source_type:"game",source_id:this.id,name:"Player"+this.player_list[c]+"Start"}),b.push(a.id),a=new BOARDFUL.ENGINE.Event({source_type:"game",source_id:this.id,name:"DealCards",deck:"draw",player:this.player_list[c],number:2}),b.push(a.id);a=new BOARDFUL.ENGINE.Event({source_type:"game",source_id:this.id,name:"RoundEnd"}),b.push(a.id),this.event_mngr.front(b)},BOARDFUL.ENGINE.Game.prototype.roundEnd=function(){var a=new BOARDFUL.ENGINE.Event({source_type:"game",source_id:this.id,name:"RoundStart"});this.event_mngr.add(a.id)},BOARDFUL.ENGINE.Game.prototype.playerStart=function(){this.current_player=(this.current_player+1)%this.player_list.length},BOARDFUL.ENGINE.Game.prototype.dealCards=function(a){var b=BOARDFUL.ENGINE.DeckList[this.deck_list[a.deck]].dealCards(a.number);console.log("deal cards",b),BOARDFUL.ENGINE.PlayerList[a.player].hand=BOARDFUL.ENGINE.PlayerList[a.player].hand.concat(b)},BOARDFUL.ENGINE.Game.prototype.playersDuel=function(){var a=new BOARDFUL.ENGINE.Event({source_type:"game",source_id:this.id,name:"PlayersDuel"});this.event_mngr.add(a.id)};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.ENGINE=BOARDFUL.ENGINE||new Object,BOARDFUL.ENGINE.Logger=function(){var a;switch(BOARDFUL.ENGINE.Envi.type){case"nodejs":global.winston=require("winston"),a=new BOARDFUL.ENGINE.WinstonLogger({transports:[new winston.transports.Console]});break;case"browser":a=new BOARDFUL.ENGINE.DefaultLogger;break;default:a=new BOARDFUL.ENGINE.DefaultLogger}return a},BOARDFUL.ENGINE.DefaultLogger=function(){return console},BOARDFUL.ENGINE.DefaultLogger.prototype.add=function(){return this},BOARDFUL.ENGINE.DefaultLogger.prototype.remove=function(){return this},BOARDFUL.ENGINE.WinstonLogger=function(a){return this.winston=new winston.Logger(a),this.winston.log_base=this.winston.log,this.winston.log=function(){if("nodejs"==BOARDFUL.ENGINE.Envi.type)for(var a in arguments)("array"==typeof arguments[a]||"object"==typeof arguments[a]||"function"==typeof arguments[a])&&(arguments[a]=BOARDFUL.ENGINE.toString(arguments[a]));return this.log_base.apply(this,arguments)},this.winston};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.ENGINE=BOARDFUL.ENGINE||new Object,BOARDFUL.ENGINE.Player=function(a,b){switch(this.id=BOARDFUL.ENGINE.Player.next_id,BOARDFUL.ENGINE.PlayerList[this.id]=this,++BOARDFUL.ENGINE.Player.next_id,this.game_id=b,this.game=BOARDFUL.ENGINE.GameList[this.game_id],this.hand=new Array,this.turn=void 0,this.type=void 0,a){case"me":this.type="me";break;case"ai":this.type="ai";break;default:this.type="other"}var c=this;this.game.event_mngr.on("Player"+this.id+"Start",{level:"game",callback:function(a){c.start(a)},instance:c})},BOARDFUL.ENGINE.Player.next_id=0,BOARDFUL.ENGINE.Player.prototype.start=function(){console.log("player start",this.game.player_list[this.game.current_player]);var a=new BOARDFUL.ENGINE.Event({source_type:"game",source_id:this.id,name:"PlayerEnd"});this.game.event_mngr.front(a.id)},BOARDFUL.ENGINE.Player.prototype.playCard=function(){if(0!=this.hand.length){var a=this.hand[Math.floor(Math.random()*this.hand.length)],b=new BOARDFUL.ENGINE.Event({source_type:"game",source_id:this.id,name:"PlayCard",player:this.id,card:a});this.game.event_mngr.front(b.id)}},BOARDFUL.ENGINE.PlayerList=new Object,BOARDFUL.ENGINE.getPlayerList=function(a){var b,c=new Array;for(var d in a){switch(a[d]){case"me":b=new BOARDFUL.ENGINE.Player("me");break;case"ai":b=new BOARDFUL.ENGINE.Player("ai")}c.push(b.id)}return c};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.ENGINE=BOARDFUL.ENGINE||new Object,BOARDFUL.ENGINE.Room=function(a){this.id=BOARDFUL.ENGINE.Room.next_id,BOARDFUL.ENGINE.RoomList[this.id]=this,++BOARDFUL.ENGINE.Room.next_id,this.config=a,this.options=a.options,this.player_list=a.player_list||["me","ai"]},BOARDFUL.ENGINE.Room.next_id=0,BOARDFUL.ENGINE.RoomList=new Object;var BOARDFUL=BOARDFUL||new Object;BOARDFUL.ENGINE=BOARDFUL.ENGINE||new Object,BOARDFUL.ENGINE.Table=function(){};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.ENGINE=BOARDFUL.ENGINE||new Object,BOARDFUL.ENGINE.getFunctionFromString=function(a){var b=window,c=a.split(".");for(i=0;i<c.length-1;i++)if(b=b[c[i]],void 0==b)return;return b[c[c.length-1]]},BOARDFUL.ENGINE.toString=function(a){var b=a;try{b=JSON.stringify(a)}catch(c){if("array"==typeof a||"object"==typeof a||"function"==typeof a){b="{";for(var d in a){if(b+=d+":","array"==typeof a[d]||"object"==typeof a[d]||"function"==typeof a[d]){b+="{";for(var e in a[d])b+=e+":",b+="array"==typeof a[d][e]||"object"==typeof a[d][e]||"function"==typeof a[e]?typeof a[d][e]:a[d][e],b+=",";b+="}"}else b+=a[d];b+=","}b+="}"}else b=""+a}return b},BOARDFUL.ENGINE.Envi=new Object,BOARDFUL.ENGINE.checkEnvi=function(){"undefined"!=typeof module&&module.exports?BOARDFUL.ENGINE.Envi.type="nodejs":(BOARDFUL.ENGINE.Envi.type="browser",BOARDFUL.ENGINE.Envi.isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,BOARDFUL.ENGINE.Envi.isFirefox="undefined"!=typeof InstallTrigger,BOARDFUL.ENGINE.Envi.isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,BOARDFUL.ENGINE.Envi.isChrome=!!window.chrome&&!isOpera,BOARDFUL.ENGINE.Envi.isIE=!1||!!document.documentMode)},BOARDFUL.ENGINE.parseUrlParam=function(a){for(var b={},a=a||window.location.search.substring(1),c=a.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if("undefined"==typeof b[e[0]])b[e[0]]=e[1];else if("string"==typeof b[e[0]]){var f=[b[e[0]],e[1]];b[e[0]]=f}else b[e[0]].push(e[1])}return b},BOARDFUL.ENGINE.parseUrl=function(){var a=BOARDFUL.ENGINE.parseUrlParam(window.location.search.substring(1));a["#"]=window.location.hash.substring(1);var b=BOARDFUL.ENGINE.parseUrlParam(window.location.hash.substring(1));for(var c in b)c in a||(a[c]=b[c]);return a},BOARDFUL.ENGINE.shuffle=function(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.GAME=BOARDFUL.GAME||new Object,BOARDFUL.GAME.init=function(){$("#content").empty(),$("#content").load("src/browser/game.html");new BOARDFUL.ENGINE.loadFileList(["src/browser/game.css"],function(){});$("#content button#ok").on("click",function(){})};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.MENUS=BOARDFUL.MENUS||new Object,BOARDFUL.MENUS.GameList=new Object,BOARDFUL.MENUS.run=function(){$("#content").empty(),$("#content").load("src/browser/menu0.html");new BOARDFUL.ENGINE.loadFileList(["src/browser/menu0.css","src/engine/gamelist.json"],function(){BOARDFUL.MENUS.GameList=BOARDFUL.ENGINE.FileList[BOARDFUL.ENGINE.FileNameList["src/engine/gamelist.json"]].content.games,BOARDFUL.MENUS.loadGameList(BOARDFUL.MENUS.GameList)})},BOARDFUL.MENUS.Selected=void 0,BOARDFUL.MENUS.loadGameList=function(a){$("#content button#ok").click(function(){void 0!==BOARDFUL.MENUS.Selected&&BOARDFUL.MENUS.Selected in BOARDFUL.MENUS.GameList&&BOARDFUL.MENUS.roomStart(BOARDFUL.MENUS.GameList[BOARDFUL.MENUS.Selected])});for(var b in a)$("#content #gamelist ul").append('<li id="'+b+'">'+a[b].name+"</li>"),$("#content #gamelist ul li:last").click(function(){BOARDFUL.MENUS.Selected=$(this).attr("id"),$("#content #gamelist li").removeClass("active"),$(this).addClass("active"),$("#content #descrip").empty(),$("#content #descrip").append(a[BOARDFUL.MENUS.Selected].descrip)})};var BOARDFUL=BOARDFUL||new Object;BOARDFUL.MENUS=BOARDFUL.MENUS||new Object,BOARDFUL.MENUS.GamePackage=new Object,BOARDFUL.MENUS.roomStart=function(a){$("#content").empty(),$("#content").load("src/browser/menu1.html");new BOARDFUL.ENGINE.loadFileList(["src/browser/menu1.css",a["package"]],function(){BOARDFUL.MENUS.GamePackage=BOARDFUL.ENGINE.FileList[BOARDFUL.ENGINE.FileNameList[a["package"]]].content,BOARDFUL.MENUS.setRoom(BOARDFUL.MENUS.GamePackage)})},BOARDFUL.MENUS.setRoom=function(a){$("#content button#ok").on("click",function(){BOARDFUL.GAME.init(BOARDFUL.MENUS.GamePackage)}),$("#content #name").html(a.name),$("#content #descrip1").html(a.descrip),$("#content #players").append("<div><span>me</span></div>");for(var b=1;b<a.max_players;++b)$("#content #players").append("<div><span>empty</span></div>");for(var b in a.options){$("#content #options").append('<div id="'+b+'"></div>'),$("#content #options #"+b).append("<span>"+b+"</span><select></select>");for(var c in a.options[b].value)$("#content #options #"+b+" select").append('<option value="'+a.options[b].value[c]+'">'+a.options[b].value[c]+"</option>")}};